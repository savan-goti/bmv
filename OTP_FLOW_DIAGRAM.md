# OTP Login Flow Diagram

## ğŸ“§ Email OTP Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Customer  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 1. Request OTP
       â”‚ POST /api/customer/send-otp
       â”‚ { type: "email", identifier: "user@example.com" }
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AuthController  â”‚
â”‚   sendOTP()      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ 2. Generate 6-digit OTP
         â”‚ 3. Save to email_otp field
         â”‚ 4. Set email_otp_expired_at (now + 10 min)
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CustomerOTPMail  â”‚
â”‚  (Mailable)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ 5. Send email via SMTP
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Customer Inbox  â”‚
â”‚  ğŸ“§ OTP: 123456  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ 6. Customer enters OTP
         â”‚ POST /api/customer/verify-otp
         â”‚ { type: "email", identifier: "user@example.com", otp: "123456" }
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AuthController  â”‚
â”‚   verifyOTP()    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ 7. Validate OTP
         â”‚ 8. Check expiration
         â”‚ 9. Clear email_otp fields
         â”‚ 10. Generate JWT token
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Customer       â”‚
â”‚   âœ… Logged In   â”‚
â”‚   ğŸ”‘ JWT Token   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“± Phone OTP Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Customer  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 1. Request OTP
       â”‚ POST /api/customer/send-otp
       â”‚ { type: "phone", identifier: "9876543210", country_code: "+91" }
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AuthController  â”‚
â”‚   sendOTP()      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ 2. Generate 6-digit OTP
         â”‚ 3. Save to phone_otp field
         â”‚ 4. Set otp_expired_at (now + 10 min)
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  TwilioService   â”‚
â”‚   sendOTP()      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ 5. Send SMS via Twilio API
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Customer Phone  â”‚
â”‚  ğŸ“± OTP: 123456  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ 6. Customer enters OTP
         â”‚ POST /api/customer/verify-otp
         â”‚ { type: "phone", identifier: "9876543210", otp: "123456" }
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AuthController  â”‚
â”‚   verifyOTP()    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ 7. Validate OTP
         â”‚ 8. Check expiration
         â”‚ 9. Set phone_validate = true
         â”‚ 10. Clear phone_otp fields
         â”‚ 11. Generate JWT token
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Customer       â”‚
â”‚   âœ… Logged In   â”‚
â”‚   ğŸ”‘ JWT Token   â”‚
â”‚   âœ“ Phone Verifiedâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ Resend OTP Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Customer  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ Didn't receive OTP?
       â”‚ POST /api/customer/resend-otp
       â”‚ { type: "email/phone", identifier: "..." }
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AuthController  â”‚
â”‚   resendOTP()    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ Check rate limit
         â”‚ (1 minute wait)
         â”‚
         â”œâ”€â”€â”€ â±ï¸ Too Soon â”€â”€â”€â”
         â”‚                   â”‚
         â”‚                   â–¼
         â”‚            âŒ 429 Error
         â”‚            "Wait X seconds"
         â”‚
         â””â”€â”€â”€ âœ… OK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                             â”‚
                             â–¼
                    Generate new OTP
                    Send via email/SMS
                             â”‚
                             â–¼
                    âœ… OTP Resent
```

---

## ğŸ—„ï¸ Database State Changes

### Before OTP Request
```
customers table:
â”Œâ”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ id â”‚ email         â”‚ phone    â”‚ email_otp â”‚ email_otp_exp... â”‚
â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1  â”‚ user@test.com â”‚ 98765... â”‚ NULL      â”‚ NULL             â”‚
â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### After Email OTP Request
```
customers table:
â”Œâ”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ id â”‚ email         â”‚ phone    â”‚ email_otp â”‚ email_otp_expired_at â”‚
â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1  â”‚ user@test.com â”‚ 98765... â”‚ 123456    â”‚ 2026-01-27 22:02:00  â”‚
â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### After Successful Verification
```
customers table:
â”Œâ”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ id â”‚ email         â”‚ phone    â”‚ email_otp â”‚ email_otp_exp... â”‚
â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1  â”‚ user@test.com â”‚ 98765... â”‚ NULL      â”‚ NULL             â”‚
â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â†‘
                            OTP cleared after use
```

---

## ğŸ” Security Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             OTP Security Layers                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                 â”‚
â”‚  1. â±ï¸  Expiration (10 minutes)                 â”‚
â”‚      â””â”€ Prevents old OTPs from being used      â”‚
â”‚                                                 â”‚
â”‚  2. ğŸ”’  One-Time Use                            â”‚
â”‚      â””â”€ OTP cleared after verification         â”‚
â”‚                                                 â”‚
â”‚  3. ğŸš¦  Rate Limiting (1 minute)                â”‚
â”‚      â””â”€ Prevents brute force attacks           â”‚
â”‚                                                 â”‚
â”‚  4. ğŸ²  Random Generation (6 digits)            â”‚
â”‚      â””â”€ 1,000,000 possible combinations        â”‚
â”‚                                                 â”‚
â”‚  5. ğŸ”  Separate Storage                        â”‚
â”‚      â””â”€ Email OTP â‰  Phone OTP                  â”‚
â”‚                                                 â”‚
â”‚  6. ğŸ™ˆ  Hidden in Responses                     â”‚
â”‚      â””â”€ Not exposed in API (except debug)      â”‚
â”‚                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š Decision Tree

```
                    Customer wants to login
                            â”‚
                            â–¼
                    Choose login method
                            â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚                           â”‚
         Email OTP                   Phone OTP
              â”‚                           â”‚
              â–¼                           â–¼
    Enter email address         Enter phone + country code
              â”‚                           â”‚
              â–¼                           â–¼
    Send OTP to email            Send OTP to phone
              â”‚                           â”‚
              â–¼                           â–¼
    Check email inbox            Check SMS messages
              â”‚                           â”‚
              â–¼                           â–¼
         Enter OTP                   Enter OTP
              â”‚                           â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
                    Verify OTP code
                            â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚                           â”‚
          âœ… Valid                    âŒ Invalid
              â”‚                           â”‚
              â–¼                           â–¼
      Generate JWT token          Show error message
              â”‚                           â”‚
              â–¼                           â–¼
       Customer logged in         Try again or resend
```

---

## ğŸ¯ API Endpoint Map

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           OTP API Endpoints                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                 â”‚
â”‚  POST /api/customer/send-otp                    â”‚
â”‚  â”œâ”€ Email: { type: "email", identifier: ... }  â”‚
â”‚  â””â”€ Phone: { type: "phone", identifier: ...,   â”‚
â”‚             country_code: ... }                 â”‚
â”‚                                                 â”‚
â”‚  POST /api/customer/verify-otp                  â”‚
â”‚  â””â”€ { type: "email/phone", identifier: ...,    â”‚
â”‚       otp: "123456" }                           â”‚
â”‚                                                 â”‚
â”‚  POST /api/customer/resend-otp                  â”‚
â”‚  â”œâ”€ Email: { type: "email", identifier: ... }  â”‚
â”‚  â””â”€ Phone: { type: "phone", identifier: ...,   â”‚
â”‚             country_code: ... }                 â”‚
â”‚                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ Complete User Journey

```
1. ğŸ  User opens app
   â”‚
2. ğŸ”‘ Clicks "Login with OTP"
   â”‚
3. ğŸ“§/ğŸ“± Chooses Email or Phone
   â”‚
4. âŒ¨ï¸  Enters email/phone
   â”‚
5. ğŸ“¤ Taps "Send OTP"
   â”‚
6. â³ Waits for OTP (email/SMS)
   â”‚
7. ğŸ“¬ Receives OTP code
   â”‚
8. âŒ¨ï¸  Enters 6-digit code
   â”‚
9. âœ… Taps "Verify"
   â”‚
10. ğŸ‰ Logged in successfully!
    â”‚
11. ğŸ  Redirected to home/dashboard
```

---

**Visual representation of the OTP login system implementation** ğŸ¨
